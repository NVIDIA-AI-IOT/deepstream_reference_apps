################################################################################
# SPDX-FileCopyrightText: Copyright (c) 2018-2024 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
################################################################################

Refer to the DeepStream SDK documentation for a description of the plugin.

--------------------------------------------------------------------------------
Pre-requisites:
- glib-2.0
- json-glib-1.0
- uuid
- yaml-cpp

Install using:
  sudo apt-get install libglib2.0-dev libjson-glib-dev uuid-dev libyaml-cpp-dev

--------------------------------------------------------------------------------
Compiling and installing the plugin:
Run make and sudo make install

NOTE: To compile the sources, run make with "sudo" or root permission.

# How to Modify NvMsgConv Plugin?

The schema for the kafka messages sent by the DS app is defined in the [eventmsg_payload.cpp](./deepstream_schema/eventmsg_payload.cpp) file.

In this example, we will demonstrate how to build a custom message converter library to add custom message information to the message payload.

**Why should we modify the default library file?**

* Notice the [`NvDsPersonObject`](https://docs.nvidia.com/metropolis/deepstream/sdk-api/structNvDsPersonObject.html) struct provided in the `nvdsmeta_schema.h` file. The struct by default has the ability to carry only information about gender, age etc.

* The message schema for this project is different from the default schema that comes with DeepStream SDK. In order to generate this new schema, we need to modify the 

## Step 1 - Modify NvDsPersonObject

For this use case, we would like to modify the object so that it has an additional attribute [`hasBasket`](../nvdsmeta_schema.h#L159). To achieve this we modify the existing struct in `/opt/nvidia/deepstream/deepstream/sources/includes/nvdsmeta_schema.h` as below.

```c
typedef struct NvDsPersonObject {
  gchar *gender;    /**< Holds a pointer to the person's gender. */
  gchar *hair;      /**< Holds a pointer to the person's hair color. */
  gchar *cap;       /**< Holds a pointer to the type of cap the person is
                     wearing, if any. */
  gchar *apparel;   /**< Holds a pointer to a description of the person's
                     apparel. */
  guint age;        /**< Holds the person's age. */
  // Modified the stock NvDsPersonObject that comes with DeepStream 6.1
  gchar *hasBasket;
} NvDsPersonObject;
```

## Step 2 - Modify library file for NvMsgConv

Original file that comes with DeepStream SDK - [eventmsg_payload.cpp](./deepstream_schema/eventmsg_payload.cpp)

Modified file for current use case - [eventmsg_payload_peoplenet.cpp](./deepstream_schema/eventmsg_payload_peoplenet.cpp)

It is a good exercise to compare the two files to understand how to modify the original library file.

Sample message generated by the new message library

```json
{
  "messageid": "50e5a5f5-0568-4d45-9b97-4bcd5ee695be",
  "mdsversion": "1.0",
  "timestamp": "2022-08-17T04:11:15.074Z",
  "object": {
    "id": "8",
    "speed": 0,
    "direction": 0,
    "orientation": 0,
    "detection": "person",
    "obj_prop": {
      "hasBasket": "hasBasket",
      "confidence": 0.99
      },
    "bbox": {
      "topleftx": 1877,
      "toplefty": 52,
      "bottomrightx": 2524,
      "bottomrighty": 101
      }
    },
  "event_des": {
    "id": "87ad972c-175b-4eb9-9012-11999314a7e7",
    "type": "entry"
  },
  "videopath": ""
}
```

* The default library message converter plugin has fields for sensor, place, analytics data. Since we are not using any of those keys for the current project, we can remove the functions that generate those objects in the payload.

* We are concerned only with `NvDsPersonObject` for this project. We can safely remove the message creation functions for all other classes. 

* You can set the newly added attribute `hasBasket` by adding the following line to [`generate_object_object`](./deepstream_schema/eventmsg_payload_peoplenet.cpp#L72) function

```cpp
json_object_set_string_member (jobject, "hasBasket", dsObj->hasBasket);
```

## Step 3 - Compiling the C++ file to generate the library file

* Modify the path in [`Makefile`](./Makefile) to reflect the path of the new C++ file

* Run `make -B` to compile all the codes and generate the new library

* You can find the new library file in the same directory - [libnvds_msgconv.so](./libnvds_msgconv.so)

* Add the path for the newly compiled library in the [`msgconv`](../configs/retail_iva.yml#L49) section of the main config file